(ns symbolicweb.examples.nostdal-org
  (:use symbolicweb.core)
  (:use hiccup.core)
  (:require [garden.core :refer [css style]]))



(defn homepage [request session]
  (let [root-widget (mk-bte :id "_body" :root-widget? true)
        viewport (mk-Viewport request session root-widget :page-title "nostdal.org")]
    (add-resource viewport :css "sw/css/common.css")
    (add-rest-head viewport "<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no' />")
    (add-rest-head viewport (html [:style (css [:body {:background-color "rgb(171,191,181)"
                                                       :color 'black
                                                       :font-family "'DejaVu Sans', sans-serif"}]
                                               [:a {:color 'black}]
                                               [:li {:padding-bottom "0.5em"}])]))
    (add-rest-head viewport "<link href='data:image/x-icon;base64,AAABAAEAEBAQAAAAAAAoAQAAFgAAACgAAAAQAAAAIAAAAAEABAAAAAAAgAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAjIyMAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQAQAAABAQAAAQAAAAAAAAAAAAAAABAAAAAAAAAAAAAQAAAAAAABAAEAAAAAAAAAAAAAAAAAABAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAD//wAA54cAAOOHAADzvwAA878AAPk/AAD5PwAA/H8AAPx/AAD+/wAA/v8AAP7/AAD8/wAA9P8AAPH/AAD//wAA' rel='icon' type='image/x-icon' />")
    (jqAppend root-widget
      (whc [:div]
        [:h2 "nostdal.org"]

        [:ul
         [:li "Email: " [:a {:href "mailto:larsnostdal@gmail.com"} "larsnostdal@gmail.com"]]
         [:li "Some source code at " [:a {:href "https://github.com/lnostdal/"} "GitHub"]]
         [:li [:a {:href "https://en.wikipedia.org/wiki/Clojure"} "Clojure"]]
         [:li [:a {:href "https://en.wikipedia.org/wiki/PostgreSQL"} "PostgreSQL"]]
         [:li [:a {:href "https://en.wikipedia.org/wiki/Linux"} "Linux"] " (since 1998)"]
         [:li "JavaScript (e.g. jQuery), HTML5, CSS, Nginx"]
         [:li [:a {:href "https://en.wikipedia.org/wiki/JSON"} "JSON"] ", HTTP (e.g. REST), XML"]
         [:li [:a {:href "https://en.wikipedia.org/wiki/Bootstrap_(front-end_framework)"} "Twitter Bootstrap"]
          ", " [:a {:href "https://en.wikipedia.org/wiki/Foundation_(framework)"} "Foundation (ZURB)"]
          " (nice for mobile devices)"]]

        [:p
         [:em "NOTE: I haven't bothered updating my HTTPS CA for this domain (nostdal.org). I thought about this for a year now, and I think CA's are a terrible idea. If you want to reach this site via an encrypted line " [:b "and"] " be 100% sure that you're not getting " [:a {:href "https://en.wikipedia.org/wiki/Man-in-the-middle_attack"} "MITM'ed"] ", do so via the Darknet (" [:a {:href "https://geti2p.net/en/"} "I2P"] ") where 3rd party trust (extra risk) is not needed at all: "
          [:a {:href "http://o6v2tmi2jc54b3rt5v6gd5qgie4yvvg4ocpyqtvy4rfxbgkecsjq.b32.i2p/nostdal.org"} "http://o6v2tmi2jc54b3rt5v6gd5qgie4yvvg4ocpyqtvy4rfxbgkecsjq.b32.i2p/nostdal.org"] ". I've digitally signed this URL here:"]]

        [:p
         [:pre
          "-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA512

http://o6v2tmi2jc54b3rt5v6gd5qgie4yvvg4ocpyqtvy4rfxbgkecsjq.b32.i2p/nostdal.org
-----BEGIN PGP SIGNATURE-----
Version: GnuPG v2.0.20 (GNU/Linux)

iQIcBAEBCgAGBQJTOs10AAoJEKCKx3p7KBrtK8YP/1WIVT5jjR7NZyZhfKO2TK2/
NlgnfIVmzI4hRibhut+idjrXfWvEyD0XIvvzz3fKwkCO+uY/uHAVPB2phu5aR5bE
DWbPtIDObAMzVn60MLt4VGhv5i1rjK67tdu7N5MX+5rLkQOoW6xySGT6FLx6ETL2
N3Ga7pzVMaMQII1OWk8SsQwBXAhKLVpSjOsgK/cyd/024yI0F3hFZO4kVYTAm4Nt
iJ4E2e6Q7vPWY6fQGCRqdAqE7qA1gqaWYH83W73YtwEkWMVPPAkac/reOYR82KPP
vhp5+dtvV7CE+g1Z3pNJDT7NlZR/xdNVBvqZDf5y/Ye9PlPr5mJdxfWRjmECX4/S
x/6Oat1teJEJvJCKyBH/JoirhZSMx4q+yK3OGE3gIg+BzUcKj5/YnKEmFgaMiK23
0O5ig8Zt6R/Kgw4clkV6bz735ybVR3fd/hSpViox+ajQUfFVWJoi/OJBxavv+PAg
uxUV/bdHkeI++cWDn6T/HWkiC80QL02m9xh/oB3F+laN4o2rPtuBYY7DLwds1j7P
bAz9QAIAJYKNXPOR3WLdjahv8q/N4VKhDjNbdp1oGoxOSnpUu6CN9OcR91HfNOxJ
vDBgdEj1a5UFaQYMe5zs3PXUcF8hM5XvR/O7eg/t0TNgeS2DbhtWKl/uqgilP9if
V5+Jcg3lyI2SvDFY0Pke
=Jj6N
-----END PGP SIGNATURE-----"]]

        [:p {:style (style {:font-family 'monospace})}
         "pub   4096R/7B281AED 2013-01-24" [:br]
         "Key fingerprint = 5029 6FDD 199C 2A69 898B  40B0 A08A C77A 7B28 1AED" [:br]
         "uid                  Lars Rune NÃ¸stdal (PGP (RSA)) <larsnostdal@gmail.com>" [:br]
         "sub   4096R/F53DFC31 2013-01-24"]


        [:hr]
        [:p {:style (style {:float 'right :font-family 'monospace})}
         "This page was generated by " [:a {:href "https://github.com/lnostdal/SymbolicWeb"} "SymbolicWeb"] ": "
         [:a {:href "https://en.wikipedia.org/wiki/Homoiconicity"} "data &#8596; code"] "."]
        ))
    viewport))



(defmulti mk-nostdal-org-viewport #(first %&))

(defmethod mk-nostdal-org-viewport :default [^String uri request session]
  (mk-Viewport request session (mk-bte :root-widget? true) :page-title "SW: :default"))

(defmethod mk-nostdal-org-viewport "/nostdal.org" [^String uri request session]
  (homepage request session))



(defapp
  [::Nostdal-org
   (fn [request]
     (in (:server-name request)
         "nostdal.org"
         "aafoss.nostdal.org"
         "localhost.nostdal.org"
         "localhost"
         "127.0.0.1"
         "symbolicweb.i2p"
         "o6v2tmi2jc54b3rt5v6gd5qgie4yvvg4ocpyqtvy4rfxbgkecsjq.b32.i2p" ;; nostdal.org
         "4jiq4axgdpk3bmnfmbtmuoj3cjhnaj74lbhqptvc2fhdabvsgncq.b32.i2p" ;; Laptop.
         ))]

  (fn [request session]
    (if (= (:uri request) "/") ;; Can't set a cookie here as it will become global for all paths; redirect instead.
      (alter session assoc
             :rest-handler (fn [request session viewport]
                             (http-redirect-response "/nostdal.org"))
             :one-shot? true)
      (alter session assoc
             :mk-viewport-fn (fn [request session]
                               (mk-nostdal-org-viewport (:uri request) request session))))
    session))
